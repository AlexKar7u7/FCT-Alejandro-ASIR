{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="{% static 'blog/static.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <title>{% block title %}Mi sitio{% endblock %}</title>
  <style>
    .nav-icon {
      height: 34px;
      vertical-align: middle;
      margin-right: 5px;
    }

    /* Support both legacy body.dark-mode and Tailwind's .dark on root */
    .dark .nav-icon,
    body.dark-mode .nav-icon {
      filter: none;
    }
  </style>
</head>

<body>
  <header>
    <nav class="flex items-center justify-between p-4">
      <div class="nav-left flex items-center">
        <a href="{% url 'inicio' %}" class="nav-icon-link inline-flex items-center">
          <img src="{% static 'blog/icono.webp' %}" alt="Icono del Sitio" class="nav-icon">
        </a>
        <div class="ml-3 space-x-3">
          <a href="{% url 'inicio' %}">Inicio</a>
          <a href="{% url 'lista_articulos' %}">Art√≠culos</a>
          <a href="{% url 'nueva_peticion' %}">Solicitar Petici√≥n</a>
          <a href="{% url 'lista_propuestas' %}">Lista Propuestas</a>
          <a href="{% url 'lista_temas' %}">Foro</a>
          <a href="{% url 'lista_guias' %}">Gu√≠as</a>
        </div>
      </div>

      <div class="nav-right flex items-center space-x-3">
        {% if user.is_authenticated %}
        <span>Hola, {{ user.username }}</span>
        {% if user.is_staff %}
        <a href="/admin/">Ir al Admin</a>
        {% endif %}
        <form action="{% url 'logout' %}" method="post" style="display:inline;" class="frm-logout">
          {% csrf_token %}
          <button type="submit" class="nav-link">Cerrar sesi√≥n</button>
        </form>
        {% else %}
        <a href="{% url 'login' %}">Iniciar sesi√≥n</a>
        {% endif %}

        <button id="theme-toggle" class="btn btn-link nav-link" aria-label="Toggle theme">üåô</button>
      </div>
    </nav>
  </header>

  <main>
    {% block content %}{% endblock %}
  </main>

  <footer class="text-center p-4">
    <p>&copy; 2025 GS Storm | <a href="{% url 'contacto' %}">Contacto</a> | <a href="{% url 'aviso_legal' %}">Aviso legal</a></p>
  </footer>

  <script>
    (function () {
      const toggle = document.getElementById('theme-toggle');
      const root = document.documentElement;
      const body = document.body;

      function updateButton(theme) {
        if (theme === 'dark') {
          toggle.textContent = '‚òÄÔ∏è';
          toggle.setAttribute('aria-pressed', 'true');
          toggle.title = 'Cambiar a modo claro';
        } else {
          toggle.textContent = 'üåô';
          toggle.setAttribute('aria-pressed', 'false');
          toggle.title = 'Cambiar a modo oscuro';
        }
      }

      function applyTheme(theme, persist = true) {
        if (theme === 'dark') {
          root.classList.add('dark');
          body.classList.add('dark-mode');
        } else {
          root.classList.remove('dark');
          body.classList.remove('dark-mode');
        }
        updateButton(theme);
        if (persist) localStorage.setItem('theme', theme);
      }

      // 1. Determine initial theme: saved preference > system preference > light
      try {
        const saved = localStorage.getItem('theme');
        if (saved === 'dark' || saved === 'light') {
          applyTheme(saved, false);
        } else {
          const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
          applyTheme(prefersDark ? 'dark' : 'light', false);
        }
      } catch (e) {
        // localStorage might be unavailable
        applyTheme('light', false);
      }

      // 2. Toggle on click and persist
      toggle.addEventListener('click', () => {
        const isDark = root.classList.toggle('dark');
        body.classList.toggle('dark-mode', isDark);
        applyTheme(isDark ? 'dark' : 'light');
      });

      // 3. Listen to system changes (optional): update when user changes OS theme and no explicit preference
      try {
        window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
          const savedPref = localStorage.getItem('theme');
          if (!savedPref) {
            applyTheme(e.matches ? 'dark' : 'light', false);
          }
        });
      } catch (e) {
        // ignore
      }
    })();
  </script>
</body>

</html>
